# Файл: nginx.conf

server {
    listen 80;
    root /usr/share/nginx/html;
    index index.html;

    resolver 127.0.0.11 valid=10s;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location ~ ^/(api|chathub|voiceCallHub) {
    set $backend_host http://thrume-api:8080;
    proxy_pass $backend_host;

    # --- Standard Proxy Headers ---
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # --- WebSocket Headers ---
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # --- NEW: Add Resilience ---
    # Set a longer timeout for connecting to the backend. Default is 60s, but let's be explicit.
    proxy_connect_timeout 60s;
    
    # If the backend returns a 502, 503, or 504 error, or if there's a timeout,
    # Nginx can try the request again. This helps with "cold start" issues.
    proxy_next_upstream error timeout http_502 http_503 http_504;
    
    # Prevent the client's original request headers from being passed if empty.
    proxy_pass_request_headers on;
    proxy_set_header Accept-Encoding ""; # Can help with gzip issues
}
}